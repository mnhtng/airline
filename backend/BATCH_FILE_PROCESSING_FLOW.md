# ğŸ“Š PHÃ‚N TÃCH LOGIC Xá»¬ LÃ BATCH FILE EXCEL

## ğŸ“‹ Má»¥c lá»¥c

- [1. Tá»•ng quan](#1-tá»•ng-quan)
- [2. Flow Tá»•ng quan](#2-flow-tá»•ng-quan)
- [3. Sequence Diagram Chi tiáº¿t](#3-sequence-diagram-chi-tiáº¿t)
- [4. State Transition Diagram](#4-state-transition-diagram)
- [5. Frontend Logic](#5-frontend-logic)
- [6. Backend Logic](#6-backend-logic)
- [7. Data Processing Logic](#7-data-processing-logic)
- [8. Stored Procedures Deep Dive](#8-stored-procedures-deep-dive)
- [9. Database Schema](#9-database-schema)
- [10. Validation Layers](#10-validation-layers)
- [11. Error Scenarios](#11-error-scenarios)
- [12. Performance & Monitoring](#12-performance--monitoring)
- [13. Best Practices](#13-best-practices)
- [14. Testing Strategy](#14-testing-strategy)
- [15. Future Enhancements](#15-future-enhancements)

---

## 1. Tá»•ng quan

Document nÃ y phÃ¢n tÃ­ch chi tiáº¿t vÃ  toÃ n diá»‡n luá»“ng xá»­ lÃ½ batch file Excel tá»« Frontend (React) Ä‘áº¿n Backend (FastAPI), bao gá»“m:

- âœ… **Upload Flow**: Multi-file upload vá»›i validation
- âœ… **Processing Pipeline**: PhÃ¢n loáº¡i, extract, transform data theo loáº¡i file (MN/MB/MT)
- âœ… **Data Cleaning**: Stored procedures Ä‘á»ƒ clean, enrich, validate
- âœ… **Error Handling**: Multi-layer error detection vÃ  reporting
- âœ… **State Management**: Tracking data flow qua cÃ¡c tables
- âœ… **Monitoring**: Real-time statistics vÃ  progress tracking

### Kiáº¿n trÃºc tá»•ng thá»ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚  React + TypeScript
â”‚   (Browser)     â”‚  - File upload UI
â”‚                 â”‚  - Progress tracking
â”‚                 â”‚  - Result display
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTP/HTTPS (FormData)
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Backend API   â”‚  FastAPI + SQLAlchemy
â”‚   (/upload)     â”‚  - File validation
â”‚                 â”‚  - Temp storage
â”‚                 â”‚  - Excel processing
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Excel Batch    â”‚  Pandas + Custom Logic
â”‚  Processor      â”‚  - MN/MB/MT detection
â”‚                 â”‚  - Column mapping
â”‚                 â”‚  - Data extraction
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Database      â”‚  SQL Server
â”‚   (Raw Tables)  â”‚  - flight_raw
â”‚                 â”‚  - import_log
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stored Procs   â”‚  T-SQL
â”‚  (Cleaning)     â”‚  - usp_CleanAndProcessFlightData
â”‚                 â”‚  - usp_CleanAndValidateFlightData
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Database      â”‚  SQL Server
â”‚  (Final Tables) â”‚  - flight_data_chot
â”‚                 â”‚  - error_table
â”‚                 â”‚  - Missing_Dimensions_Log
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Flow Tá»•ng quan

### 2.1. High-Level Flow

```mermaid
graph TD
    A[ğŸ‘¤ User Upload Files] --> B[ğŸ“¤ Frontend: Táº¡o FormData]
    B --> C[ğŸŒ POST /upload-files API]
    C --> D[ğŸ’¾ Backend: LÆ°u vÃ o Temp Directory]
    D --> E[ğŸ”„ Loop qua tá»«ng file]
    E --> F{ğŸ“‹ File Ä‘Ã£ import?}
    F -->|Yes| G[â­ï¸ Skip file + counter++]
    F -->|No| H[ğŸ” XÃ¡c Ä‘á»‹nh loáº¡i file MN/MB/MT]
    H --> I{âœ… Loáº¡i file valid?}
    I -->|No| Z1[âŒ Add error, continue]
    I -->|Yes| J[ğŸ“– Äá»c & parse Excel]
    J --> K[ğŸ”§ Process theo loáº¡i file]
    K --> L{ğŸ“Š Data valid?}
    L -->|No| Z2[âŒ Add error, continue]
    L -->|Yes| M[ğŸ’¾ LÆ°u vÃ o flight_raw]
    M --> N[ğŸ“ Ghi log import_log]
    N --> O[âœ… Update counters]
    O --> P{ğŸ” CÃ²n file?}
    P -->|Yes| E
    P -->|No| Q[ğŸ’¾ Commit raw data]
    Q --> R[ğŸ§¹ Run SP: CleanAndProcess]
    R --> S[âœ”ï¸ Run SP: Validate]
    S --> T[ğŸ“Š Get Processing Summary]
    T --> U[ğŸ“¤ Return JSON Response]
    U --> V[ğŸ–¥ï¸ Frontend: Parse & Display]
    V --> W[ğŸ‰ Show Toast Notifications]
    W --> X[ğŸ“Š Render Statistics]
```

### 2.2. Swimlane Diagram - Actor Interactions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    USER     â”‚    FRONTEND      â”‚    BACKEND API   â”‚   PROCESSOR    â”‚   DATABASE   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚ Select Filesâ”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚ Validate Files   â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚ (client-side)    â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚         â”‚        â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚ Create FormData  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚         â”‚        â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚ POST /upload     â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚ Save to Temp     â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚         â”‚        â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚ Check Duplicate  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚ Query import   â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚ Return result  â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚ Result           â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚ Process Excel    â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚ Read Excel     â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚ Parse Sheets   â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚ Map Columns    â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚ Clean Data     â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚ DataFrame        â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚ Save to DB       â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚ INSERT       â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚ flight_raw   â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚ Commit           â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚ COMMIT       â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚ Run SP: Clean    â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚ EXEC SP      â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚ Clean+Enrich â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚ Run SP: Validate â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚ EXEC SP      â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚ Validate+Log â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚ Get Summary      â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚ Query Stats  â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚ Statistics       â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚ JSON Response    â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚ Display     â”‚ Parse + Render   â”‚                  â”‚                â”‚              â”‚
â”‚ Results     â”‚ Statistics       â”‚                  â”‚                â”‚              â”‚
â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                  â”‚                â”‚              â”‚
â”‚             â”‚                  â”‚                  â”‚                â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Sequence Diagram Chi tiáº¿t

### 3.1. File Upload & Processing Sequence

```
USER         FRONTEND          API ENDPOINT         PROCESSOR         DATABASE         STORED PROC
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚ Click Upload   â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚ Validate Extensionsâ”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚ (.xlsx, .xls)     â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”            â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚       â”‚            â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”˜            â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚ Create FormData()  â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”            â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚       â”‚            â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”˜            â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚ POST /upload-files â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚ (multipart/form)   â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ Create TempDir    â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚          â”‚        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ for file in files:â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚          â†“        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ await file.read() â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚          â”‚        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ write(temp_path)  â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚          â”‚        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ is_file_imported()â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ SELECT FROM    â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ import_log     â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ Result (bool)  â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ bool (imported?)  â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ find_matching_key â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ Match pattern  â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ (MN/MB/MT)     â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”        â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚       â”‚        â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”˜        â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ file_type         â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ process_excel_fileâ”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ pd.read_excel()â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”        â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚       â”‚        â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”˜        â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ if MN:         â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚  _process_mn() â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ elif MB:       â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚  _process_mb() â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ elif MT:       â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚  _process_mt() â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”        â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚       â”‚        â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”˜        â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ DataFrame         â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ _save_to_database â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ for record:    â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚  db.add()      â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚ (staged)        â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ (no commit)    â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ mark_file_importedâ”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ db.add(log)    â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ (staged)       â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ results.append()  â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚          â”‚        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ db.commit()       â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚ COMMIT TRANS    â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚ (flight_raw +   â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚  import_log)    â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ Success           â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ run_data_cleaning â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ _stored_procedure â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚ EXEC usp_Clean  â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚ AndProcessFlightâ”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚ Data            â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚        â”‚        â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ Success           â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ EXEC usp_Clean    â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ AndValidateFlight â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ Data              â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚ EXEC SP         â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚        â”‚        â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ Success           â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ get_processing    â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ _summary()        â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ SELECT COUNT() â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ FROM tables    â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚ Statistics     â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚ summary_dict      â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚ JSON Response      â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚ Parse & Render    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”            â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚       â”‚            â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”˜            â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚ View Results   â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                   â”‚                â”‚                 â”‚
 â”‚                â”‚                    â”‚                   â”‚                â”‚                 â”‚
```

### 3.2. Key Timing Points

| Phase | Component | Action | Avg Time | Notes |
|-------|-----------|--------|----------|-------|
| 1 | Frontend | File Selection | < 1s | User interaction |
| 2 | Frontend | Validation (client) | < 100ms | Size, extension checks |
| 3 | Network | Upload Transfer | varies | Depends on file size & network |
| 4 | Backend | Save to Temp | ~100ms/file | Disk I/O |
| 5 | Backend | Duplicate Check | ~50ms/file | DB query (indexed) |
| 6 | Processor | Excel Parsing | ~500ms-2s/file | Depends on rows |
| 7 | Processor | Data Transformation | ~200ms-1s | Pandas operations |
| 8 | Database | Bulk Insert Raw | ~500ms | Single transaction |
| 9 | Database | SP: CleanAndProcess | ~2-5s | Complex transformations |
| 10 | Database | SP: Validate | ~1-3s | Validation logic |
| 11 | Database | Get Summary | ~200ms | Aggregate queries |
| 12 | Network | Response Transfer | ~100ms | JSON serialization |
| 13 | Frontend | Render Results | ~100ms | React re-render |

**Total Time Estimate**: ~5-15 seconds for 2-5 files with ~5000-10000 rows each

---

## 4. State Transition Diagram

### 4.1. Data State Flow Through Tables

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DATA LIFECYCLE                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   [Excel File]
        â”‚
        â†“ (uploaded)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  TEMP DIR   â”‚  State: Temporary
   â”‚             â”‚  - File physically stored
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  - Not yet in database
          â”‚
          â†“ (parse & extract)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   MEMORY    â”‚  State: In-Memory DataFrame
   â”‚ (DataFrame) â”‚  - Pandas object
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  - Column mapped
          â”‚         - Data cleaned
          â†“ (bulk insert)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚         flight_raw TABLE                 â”‚  State: RAW
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ â€¢ All fields as strings                  â”‚  - Unvalidated
   â”‚ â€¢ No transformations                     â”‚  - No enrichment
   â”‚ â€¢ Source file tracked                    â”‚  - Complete audit trail
   â”‚ â€¢ Import timestamp                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â†“ (usp_CleanAndProcessFlightData)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    flight_clean_data_stg TABLE           â”‚  State: STAGING
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ â€¢ Cleaned data                           â”‚  - Trimmed, uppercase
   â”‚ â€¢ Enriched with dimensions               â”‚  - Joined with Route
   â”‚ â€¢ Validation flags set                   â”‚  - Joined with actype_seat
   â”‚ â€¢ Error reasons calculated               â”‚  - Ready for validation
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â†“ (usp_CleanAndValidateFlightData)
          â”‚
     â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
     â”‚         â”‚
     â†“         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  flight_data_chot    â”‚        â”‚    error_table       â”‚
â”‚       TABLE          â”‚        â”‚       TABLE          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ State: VALIDATED     â”‚        â”‚ State: ERROR         â”‚
â”‚                      â”‚        â”‚                      â”‚
â”‚ â€¢ TotalErrors = 0    â”‚        â”‚ â€¢ TotalErrors > 0    â”‚
â”‚ â€¢ All dimensions OK  â”‚        â”‚ â€¢ ErrorReason set    â”‚
â”‚ â€¢ Ready for reports  â”‚        â”‚ â€¢ Needs correction   â”‚
â”‚ â€¢ type_filter set    â”‚        â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â†“ (log missing)
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚ Missing_Dimensions   â”‚
                                â”‚     _Log TABLE       â”‚
                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                â”‚ â€¢ Type: ACTYPE/ROUTE â”‚
                                â”‚ â€¢ Value: missing val â”‚
                                â”‚ â€¢ Count: occurrences â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2. Record State Transitions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INITIAL â”‚  Excel file exists
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â†“ [Upload & Parse]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UPLOADED â”‚  File in temp directory
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“ [Extract & Map]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EXTRACTEDâ”‚  Data in DataFrame
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“ [Bulk Insert]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RAW    â”‚  Record in flight_raw
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  - No validation yet
     â”‚        - All original values
     â”‚
     â†“ [SP: CleanAndProcess]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGING  â”‚  Record in flight_clean_data_stg
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  - Cleaned values
     â”‚        - Enriched with lookups
     â”‚        - Validation flags set
     â”‚
     â†“ [SP: Validate]
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                 â”‚                â”‚
     â†“                 â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUCCESS  â”‚    â”‚  ERROR   â”‚    â”‚ PARTIAL  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                â”‚
     â”‚                 â”‚                â”‚
     â†“                 â†“                â†“
flight_data_chot  error_table   error_table
+ type_filter     + ErrorReason  + Multiple errors
+ All dimensions  + TotalErrors  + Logged in Missing
                                   _Dimensions_Log
```

### 4.3. Import Log States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NOT_IMPORTED  â”‚  File not in import_log
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“ [Start Processing]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROCESSING    â”‚  (implicit state, not stored)
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚
        â†“ [Success]         â†“ [Failure]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IMPORTED     â”‚   â”‚    FAILED      â”‚
â”‚                â”‚   â”‚                â”‚
â”‚ â€¢ file_name    â”‚   â”‚ â€¢ file_name    â”‚
â”‚ â€¢ file_type    â”‚   â”‚ â€¢ error_msg    â”‚
â”‚ â€¢ row_count    â”‚   â”‚ â€¢ timestamp    â”‚
â”‚ â€¢ import_date  â”‚   â”‚                â”‚
â”‚ â€¢ status:      â”‚   â”‚ â€¢ status:      â”‚
â”‚   'success'    â”‚   â”‚   'failed'     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“ [Reupload attempt]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SKIPPED      â”‚  Duplicate detected
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  Not re-imported
```

---

## 5. FRONTEND LOGIC - Index.tsx

### BÆ°á»›c 1: NgÆ°á»i dÃ¹ng upload files

**Location:** `processBatchExcelData()` function

```typescript
const processBatchExcelData = async (files: ExcelFile[]) => {
    setIsProcessing(true)

    try {
        // Prepare FormData with original files
        const formData = new FormData()
        files.forEach((fileData: ExcelFile) => {
            formData.append('files', fileData.file)
        })

        const response = await fetch(`${import.meta.env.VITE_API_URL}/data-processing/upload-files`, {
            method: 'POST',
            body: formData
        })
    }
}
```

**Chi tiáº¿t thá»±c hiá»‡n:**

1. **Set loading state**: `setIsProcessing(true)`
2. **Táº¡o FormData object**: Container Ä‘á»ƒ gá»­i multipart/form-data
3. **Append files**: Loop qua array `files`, append tá»«ng `file.file` (File object gá»‘c)
4. **Send POST request**:
   - Endpoint: `/data-processing/upload-files`
   - Method: `POST`
   - Body: `formData` (chá»©a multiple files)
   - Header: Tá»± Ä‘á»™ng set `Content-Type: multipart/form-data`

---

### BÆ°á»›c 2: Xá»­ lÃ½ Response tá»« API

```typescript
if (!response.ok) {
    const errorText = await response.text()
    console.error('API Error Response:', errorText)

    toast.error("Lá»—i khi xá»­ lÃ½ dá»¯ liá»‡u", {
        description: "Vui lÃ²ng thá»­ láº¡i.",
    })
    return
}

const result = await response.json()

// Map all response fields to ProcessResult
setProcessResult({
    success: result.success,
    message: result.message,
    processed_count: result.total_rows || 0,
    processed_files: result.processed_files,
    total_rows: result.total_rows,
    skipped_files: result.skipped_files,
    errors: result.errors,
    file_details: result.file_details,
    processing_summary: result.processing_summary,
})
```

**Chi tiáº¿t xá»­ lÃ½:**

1. **Kiá»ƒm tra response status**:
   - Náº¿u `!response.ok` (status code 4xx/5xx)
   - Log error vÃ  hiá»ƒn thá»‹ toast error
   - Return sá»›m, khÃ´ng xá»­ lÃ½ tiáº¿p

2. **Parse JSON response**: `await response.json()`

3. **Map response vÃ o state**:
   - `success`: Tráº¡ng thÃ¡i xá»­ lÃ½
   - `message`: ThÃ´ng bÃ¡o tá»•ng quan
   - `processed_count`: Tá»•ng sá»‘ báº£n ghi Ä‘Ã£ xá»­ lÃ½
   - `processed_files`: Sá»‘ file Ä‘Ã£ xá»­ lÃ½
   - `total_rows`: Tá»•ng sá»‘ dÃ²ng dá»¯ liá»‡u
   - `skipped_files`: Sá»‘ file bá»‹ skip (Ä‘Ã£ import trÆ°á»›c Ä‘Ã³)
   - `errors`: Array chá»©a cÃ¡c lá»—i
   - `file_details`: Chi tiáº¿t tá»«ng file Ä‘Ã£ xá»­ lÃ½
   - `processing_summary`: Thá»‘ng kÃª chi tiáº¿t quÃ¡ trÃ¬nh xá»­ lÃ½

---

### BÆ°á»›c 3: Hiá»ƒn thá»‹ Notification

#### 3.1. Success Notification

```typescript
if (result.success) {
    // Build detailed success message
    let description = result.message

    if (result.processed_files && result.total_rows) {
        description += `\nğŸ“Š Processed: ${result.processed_files} file vá»›i ${result.total_rows} records`
    }

    if (result.skipped_files && result.skipped_files > 0) {
        description += `\nâ­ï¸ Skipped: ${result.skipped_files} file Ä‘Ã£ import trÆ°á»›c Ä‘Ã³`
    }

    if (result.processing_summary) {
        const summary = result.processing_summary
        description += `\nâœ… Passed: ${summary.processed_records} records`
        if (summary.error_records > 0) {
            description += `\nâŒ Errors: ${summary.error_records} records`
        }
        if (summary.missing_actypes > 0 || summary.missing_routes > 0) {
            description += `\nâš ï¸ Missing: ${summary.missing_actypes} actypes, ${summary.missing_routes} routes`
        }
    }

    toast.success("Xá»­ lÃ½ dá»¯ liá»‡u thÃ nh cÃ´ng", {
        description: description,
    })
}
```

**Cáº¥u trÃºc message:**

- Message chÃ­nh tá»« API
- ğŸ“Š ThÃ´ng tin file Ä‘Ã£ xá»­ lÃ½
- â­ï¸ File bá»‹ skip (náº¿u cÃ³)
- âœ… Sá»‘ báº£n ghi processed
- âŒ Sá»‘ báº£n ghi lá»—i (náº¿u cÃ³)
- âš ï¸ Missing dimensions (náº¿u cÃ³)

#### 3.2. Error Notifications

```typescript
// Handle errors array if present
if (result.errors && result.errors.length > 0) {
    console.warn('Processing Errors:', result.errors)

    // Show first few errors as separate notifications
    result.errors.slice(0, 3).forEach((error: string, index: number) => {
        setTimeout(() => {
            toast.error(`Lá»—i ${index + 1}`, {
                description: error,
            })
        }, (index + 1) * 1000)
    })

    if (result.errors.length > 3) {
        setTimeout(() => {
            toast.info("CÃ³ thÃªm lá»—i khÃ¡c", {
                description: `VÃ  ${result.errors.length - 3} lá»—i khÃ¡c. Kiá»ƒm tra console Ä‘á»ƒ xem chi tiáº¿t.`,
            })
        }, 4000)
    }
}
```

**Logic hiá»ƒn thá»‹ lá»—i:**

- Log táº¥t cáº£ errors vÃ o console
- Hiá»ƒn thá»‹ tá»‘i Ä‘a 3 lá»—i Ä‘áº§u tiÃªn
- Má»—i lá»—i delay 1 giÃ¢y Ä‘á»ƒ user Ä‘á»c Ä‘Æ°á»£c
- Náº¿u > 3 lá»—i: hiá»ƒn thá»‹ thÃ´ng bÃ¡o "cÃ³ thÃªm lá»—i khÃ¡c"

---

### BÆ°á»›c 4: Hiá»ƒn thá»‹ Processing Summary UI

```typescript
{processResult && (
    <div className={`p-6 rounded-lg space-y-4 ${processResult.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
        {/* Header */}
        <div className="flex items-start space-x-3">
            {processResult.success ? (
                <CheckCircle className="h-6 w-6 text-green-600 mt-0.5 flex-shrink-0" />
            ) : (
                <AlertCircle className="h-6 w-6 text-red-600 mt-0.5 flex-shrink-0" />
            )}
            <div className="flex-1">
                <h4 className={`font-semibold text-lg ${processResult.success ? 'text-green-800' : 'text-red-800'}`}>
                    Káº¿t quáº£ xá»­ lÃ½ dá»¯ liá»‡u
                </h4>
                <p className={`text-sm ${processResult.success ? 'text-green-700' : 'text-red-700'}`}>
                    {processResult.message}
                </p>
            </div>
        </div>

        {/* Processing Summary Statistics */}
        {processResult.processing_summary && (
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mt-4">
                <StatCard value={processResult.processing_summary.raw_records} label="Báº£n ghi gá»‘c" color="blue" />
                <StatCard value={processResult.processing_summary.processed_records} label="Báº£n ghi Ä‘Ã£ xá»­ lÃ½" color="green" />
                <StatCard value={processResult.processing_summary.error_records} label="Lá»—i" color="red" />
                <StatCard value={processResult.processing_summary.missing_actypes} label="Actypes thiáº¿u" color="orange" />
                <StatCard value={processResult.processing_summary.missing_routes} label="Routes thiáº¿u" color="orange" />
                <StatCard value={processResult.processing_summary.imported_files} label="Files Ä‘Ã£ import" color="gray" />
            </div>
        )}
    </div>
)}
```

**CÃ¡c thÃ nh pháº§n UI:**

1. **Header**: Icon + title + message (mÃ u theo success/fail)
2. **Statistics Grid**: 6 cards hiá»ƒn thá»‹ metrics
3. **File Details**: List cÃ¡c file Ä‘Ã£ xá»­ lÃ½
4. **Errors Display**: Hiá»ƒn thá»‹ chi tiáº¿t lá»—i (náº¿u cÃ³)

---

## ğŸ”§ BACKEND LOGIC - data_processing.py

### BÆ°á»›c 1: Khá»Ÿi táº¡o vÃ  Validate

```python
@router.post("/upload-files")
async def upload_excel_files(
    files: List[UploadFile] = File(...), db: Session = Depends(get_db)
):
    """
    Upload vÃ  xá»­ lÃ½ multiple Excel files
    - Import dá»¯ liá»‡u tá»« file Excel
    - PhÃ¢n loáº¡i file theo MN, MB, MT
    - Xá»­ lÃ½ data theo tá»«ng loáº¡i
    - Cháº¡y stored procedures Ä‘á»ƒ clean vÃ  enrich data
    """

    try:
        import tempfile
        import os

        # Initialize processor
        processor = ExcelBatchProcessor(db)

        # Initialize results tracking
        results = {
            "processed_files": 0,
            "total_rows": 0,
            "skipped_files": 0,
            "errors": [],
            "file_details": [],
            "processing_summary": {},
        }

        print(f"ğŸ“¤ Báº¯t Ä‘áº§u upload vÃ  xá»­ lÃ½ {len(files)} file Excel...")
```

**Chi tiáº¿t:**

1. **Dependencies**:
   - `files`: List[UploadFile] - Array cá»§a FastAPI UploadFile objects
   - `db`: Session - SQLAlchemy database session

2. **Khá»Ÿi táº¡o processor**:
   - `ExcelBatchProcessor(db)` - Class chá»©a logic xá»­ lÃ½ Excel

3. **Results dictionary** tracking:
   - `processed_files`: Counter sá»‘ file thÃ nh cÃ´ng
   - `total_rows`: Tá»•ng sá»‘ dÃ²ng dá»¯ liá»‡u
   - `skipped_files`: Sá»‘ file bá»‹ skip
   - `errors`: Array cÃ¡c error messages
   - `file_details`: Chi tiáº¿t tá»«ng file
   - `processing_summary`: Thá»‘ng kÃª sau khi xá»­ lÃ½

---

### BÆ°á»›c 2: LÆ°u Files vÃ o Temp Directory

```python
# Create temp directory for processing
with tempfile.TemporaryDirectory() as temp_dir:
    # Save uploaded files to temp directory
    for file in files:
        if not file.filename.lower().endswith((".xlsx", ".xls")):
            results["errors"].append(
                f"File {file.filename} khÃ´ng pháº£i lÃ  Excel file"
            )
            continue

        # Extract only filename from path (in case of folder upload)
        filename_only = os.path.basename(file.filename)
        file_path = os.path.join(temp_dir, filename_only)

        # Save file
        with open(file_path, "wb") as buffer:
            content = await file.read()
            buffer.write(content)
```

**Chi tiáº¿t tá»«ng bÆ°á»›c:**

1. **Táº¡o Temp Directory**:
   - `tempfile.TemporaryDirectory()` - Context manager
   - Tá»± Ä‘á»™ng cleanup khi exit context
   - OS sáº½ xÃ³a directory vÃ  táº¥t cáº£ files bÃªn trong

2. **Loop qua tá»«ng file**:

   **2.1. Validate Extension**
   - Check extension: `.xlsx` hoáº·c `.xls`
   - Náº¿u invalid: thÃªm vÃ o `errors[]`, continue

   **2.2. Extract Filename**
   - `os.path.basename(file.filename)`
   - Loáº¡i bá» path (quan trá»ng cho folder upload)
   - VD: `folder1/folder2/file.xlsx` â†’ `file.xlsx`

   **2.3. Construct File Path**
   - `os.path.join(temp_dir, filename_only)`
   - Táº¡o full path trong temp directory

   **2.4. Save File Content**
   - `await file.read()` - Async read file content
   - Write binary content vÃ o file path

---

### BÆ°á»›c 3: Xá»­ lÃ½ tá»«ng File

```python
try:
    # Console log filename for debugging folder uploads
    print(f"ğŸ“ Processing file: {file.filename} -> {filename_only}")

    # Check if file already imported
    if processor.is_file_imported(filename_only):
        print(f"â­ï¸ File {filename_only} Ä‘Ã£ Ä‘Æ°á»£c import trÆ°á»›c Ä‘Ã³")
        results["skipped_files"] += 1
        continue

    print(f"ğŸ”„ Äang xá»­ lÃ½ file: {filename_only}")

    # Determine file type first
    file_type = processor.find_matching_key(filename_only)
    if not file_type:
        results["errors"].append(
            f"KhÃ´ng thá»ƒ xÃ¡c Ä‘á»‹nh loáº¡i file: {filename_only}"
        )
        continue

    print(f"ğŸ“ Loáº¡i file: {file_type} - {filename_only}")

    # Process Excel file using notebook logic
    df = processor.process_excel_file(file_path, filename_only)

    if df.empty:
        results["errors"].append(
            f"KhÃ´ng cÃ³ dá»¯ liá»‡u tá»« file {filename_only}"
        )
        continue

    row_count = len(df)
    print(f"ğŸ“Š Extracted {row_count} rows tá»« {filename_only}")

    # Save to flight_raw table
    processor._save_to_database(df)

    # Mark file as imported with file type
    processor.mark_file_imported(filename_only, file_type, row_count)

    results["processed_files"] += 1
    results["total_rows"] += row_count
    results["file_details"].append(
        {
            "file_name": filename_only,
            "file_type": file_type,
            "rows": row_count,
        }
    )

    print(f"âœ… ÄÃ£ lÆ°u {row_count} báº£n ghi tá»« file {filename_only}")

except Exception as e:
    error_msg = f"Lá»—i xá»­ lÃ½ file {filename_only}: {str(e)}"
    print(f"âŒ {error_msg}")
    results["errors"].append(error_msg)
```

#### 3.1. Kiá»ƒm tra File Ä‘Ã£ Import chÆ°a

**Method:** `processor.is_file_imported(filename_only)`

```python
def is_file_imported(self, filename: str) -> bool:
    """Kiá»ƒm tra xem file Ä‘Ã£ Ä‘Æ°á»£c import chÆ°a"""
    from backend.models.import_log import ImportLog
    
    existing = self.db.query(ImportLog).filter(
        ImportLog.file_name == filename
    ).first()
    
    return existing is not None
```

**Logic:**

- Query báº£ng `import_log`
- Filter theo `file_name`
- Tráº£ vá» `True` náº¿u tá»“n táº¡i, `False` náº¿u chÆ°a cÃ³
- **Purpose**: TrÃ¡nh import duplicate file

**Náº¿u Ä‘Ã£ import:**

- Log message skip
- TÄƒng counter `skipped_files`
- `continue` (skip file nÃ y)

---

#### 3.2. XÃ¡c Ä‘á»‹nh Loáº¡i File

**Method:** `processor.find_matching_key(filename_only)`

```python
def find_matching_key(self, filename: str) -> Optional[str]:
    """
    XÃ¡c Ä‘á»‹nh loáº¡i file dá»±a vÃ o tÃªn
    Returns: 'MN' | 'MB' | 'MT' | None
    """
    filename_lower = filename.lower()
    
    # Mapping patterns
    patterns = {
        'MN': ['mn', 'miá»n nam', 'mien nam'],
        'MB': ['mb', 'miá»n báº¯c', 'mien bac'],
        'MT': ['mt', 'miá»n trung', 'mien trung']
    }
    
    for key, keywords in patterns.items():
        if any(keyword in filename_lower for keyword in keywords):
            return key
    
    return None
```

**Logic:**

- Convert filename to lowercase
- Check vá»›i cÃ¡c patterns:
    - **MN**: Miá»n Nam - `['mn', 'miá»n nam', 'mien nam']`
    - **MB**: Miá»n Báº¯c - `['mb', 'miá»n báº¯c', 'mien bac']`
    - **MT**: Miá»n Trung - `['mt', 'miá»n trung', 'mien trung']`
- Tráº£ vá» key tÆ°Æ¡ng á»©ng hoáº·c `None`

**Náº¿u khÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c:**

- ThÃªm error message vÃ o `errors[]`
- `continue` (skip file nÃ y)

---

#### 3.3. Xá»­ lÃ½ Excel File

**Method:** `processor.process_excel_file(file_path, filename_only)`

```python
def process_excel_file(self, file_path: str, filename: str) -> pd.DataFrame:
    """
    Xá»­ lÃ½ Excel file:
    1. Äá»c Excel vá»›i pandas
    2. Map columns theo file type
    3. Clean vÃ  transform data
    4. Return DataFrame
    """
    
    # 1. Read Excel
    df = pd.read_excel(file_path)
    
    # 2. Determine file type and get column mapping
    file_type = self.find_matching_key(filename)
    column_mapping = self.get_column_mapping(file_type)
    
    # 3. Rename columns
    df = df.rename(columns=column_mapping)
    
    # 4. Clean data
    df = self.clean_dataframe(df)
    
    # 5. Add metadata
    df['source_file'] = filename
    df['import_date'] = datetime.now()
    
    return df
```

**Chi tiáº¿t cÃ¡c bÆ°á»›c:**

**Step 1: Äá»c Excel**

- `pd.read_excel(file_path)` - Äá»c file Excel
- Tá»± Ä‘á»™ng detect sheets, headers

**Step 2: Get Column Mapping**

- Mapping columns theo file type (MN/MB/MT)
- Má»—i loáº¡i file cÃ³ cáº¥u trÃºc columns khÃ¡c nhau

**Step 3: Rename Columns**

- Chuáº©n hÃ³a tÃªn columns
- Map sang schema cá»§a database

**Step 4: Clean Data**

- Remove duplicates
- Handle missing values
- Format dates, numbers
- Trim whitespaces

**Step 5: Add Metadata**

- `source_file`: TÃªn file gá»‘c
- `import_date`: Timestamp import

---

#### 3.4. Validate DataFrame

```python
if df.empty:
    results["errors"].append(
        f"KhÃ´ng cÃ³ dá»¯ liá»‡u tá»« file {filename_only}"
    )
    continue

row_count = len(df)
print(f"ğŸ“Š Extracted {row_count} rows tá»« {filename_only}")
```

**Validation:**

- Check `df.empty` (DataFrame rá»—ng)
- Náº¿u rá»—ng: log error, skip file
- Náº¿u cÃ³ data: tÃ­nh sá»‘ rows

---

#### 3.5. LÆ°u vÃ o Database

**Method:** `processor._save_to_database(df)`

```python
def _save_to_database(self, df: pd.DataFrame):
    """
    LÆ°u DataFrame vÃ o báº£ng flight_raw
    """
    from backend.models.flight_raw import FlightRaw
    
    # Convert DataFrame to list of dicts
    records = df.to_dict('records')
    
    # Bulk insert
    for record in records:
        flight = FlightRaw(**record)
        self.db.add(flight)
    
    # Note: KhÃ´ng commit á»Ÿ Ä‘Ã¢y, sáº½ commit sau khi process táº¥t cáº£ files
```

**Logic:**

- Convert DataFrame â†’ list of dictionaries
- Loop qua tá»«ng record
- Create `FlightRaw` model instance
- Add vÃ o session
- **ChÆ°a commit** - sáº½ commit sau

---

#### 3.6. Ghi Log Import

**Method:** `processor.mark_file_imported(filename, file_type, row_count)`

```python
def mark_file_imported(self, filename: str, file_type: str, row_count: int):
    """
    Ghi log file Ä‘Ã£ import vÃ o import_log table
    """
    from backend.models.import_log import ImportLog
    
    import_log = ImportLog(
        file_name=filename,
        file_type=file_type,
        row_count=row_count,
        import_date=datetime.now(),
        status='success'
    )
    
    self.db.add(import_log)
```

**Purpose:**

- Track files Ä‘Ã£ import
- TrÃ¡nh duplicate import
- Audit trail

**Fields:**

- `file_name`: TÃªn file
- `file_type`: MN/MB/MT
- `row_count`: Sá»‘ dÃ²ng Ä‘Ã£ import
- `import_date`: Timestamp
- `status`: success/failed

---

#### 3.7. Cáº­p nháº­t Results

```python
results["processed_files"] += 1
results["total_rows"] += row_count
results["file_details"].append(
    {
        "file_name": filename_only,
        "file_type": file_type,
        "rows": row_count,
    }
)

print(f"âœ… ÄÃ£ lÆ°u {row_count} báº£n ghi tá»« file {filename_only}")
```

**Updates:**

- Increment `processed_files` counter
- Add `row_count` vÃ o `total_rows`
- Append file detail object vÃ o array
- Log success message

---

### BÆ°á»›c 4: Commit Raw Data

```python
# Commit raw data first
db.commit()
print(f"ğŸ’¾ ÄÃ£ commit {results['total_rows']} báº£n ghi raw data")
```

**Chi tiáº¿t:**

- Commit táº¥t cáº£ raw data vÃ o database
- Äáº£m báº£o data Ä‘Æ°á»£c persist trÆ°á»›c khi xá»­ lÃ½ tiáº¿p
- Transaction boundary: All-or-nothing cho raw data

**Táº¡i sao commit á»Ÿ Ä‘Ã¢y?**

1. Raw data Ä‘Ã£ hoÃ n chá»‰nh
2. TÃ¡ch biá»‡t transaction raw import vs data cleaning
3. Náº¿u cleaning fail, raw data váº«n Ä‘Æ°á»£c giá»¯ láº¡i
4. CÃ³ thá»ƒ rerun cleaning mÃ  khÃ´ng cáº§n re-import

---

### BÆ°á»›c 5: Cháº¡y Stored Procedures

```python
# Run data cleaning and processing if files were processed
if results["processed_files"] > 0:
    print("ğŸ§¹ Báº¯t Ä‘áº§u quÃ¡ trÃ¬nh lÃ m sáº¡ch vÃ  xá»­ lÃ½ dá»¯ liá»‡u...")

    try:
        # Step 1: Clean and process flight data
        print("1ï¸âƒ£ Cháº¡y stored procedure: usp_CleanAndProcessFlightData")
        processor.run_data_cleaning_stored_procedure()

        # Step 2: Validate and move error data
        print("2ï¸âƒ£ Cháº¡y stored procedure: usp_CleanAndValidateFlightData")
        from sqlalchemy import text

        db.execute(text("EXEC usp_CleanAndValidateFlightData"))
        db.commit()

        # Get processing summary for CURRENT BATCH only
        # Extract file names from file_details
        processed_file_names = [
            detail["file_name"] for detail in results["file_details"]
        ]
        results["processing_summary"] = processor.get_current_session_summary(
            processed_file_names
        )

        print("âœ… HoÃ n thÃ nh quÃ¡ trÃ¬nh lÃ m sáº¡ch vÃ  xá»­ lÃ½ dá»¯ liá»‡u")

    except Exception as sp_error:
        print(f"âš ï¸ Lá»—i khi cháº¡y stored procedures: {sp_error}")
        results["errors"].append(f"Lá»—i stored procedure: {str(sp_error)}")
```

#### 5.1. Stored Procedure 1: usp_CleanAndProcessFlightData

**Purpose:** Clean vÃ  enrich dá»¯ liá»‡u flight

```sql
CREATE PROCEDURE usp_CleanAndProcessFlightData
AS
BEGIN
    -- 1. Clean flight_raw data
    UPDATE flight_raw
    SET 
        route = UPPER(TRIM(route)),
        actype = UPPER(TRIM(actype)),
        flight_date = CONVERT(DATE, flight_date)
    WHERE route IS NOT NULL

    -- 2. Insert into flight_clean_data_stg
    INSERT INTO flight_clean_data_stg (
        route, actype, flight_date, pax, flight_number,
        departure_time, arrival_time, source_file
    )
    SELECT 
        fr.route,
        fr.actype,
        fr.flight_date,
        fr.pax,
        fr.flight_number,
        fr.departure_time,
        fr.arrival_time,
        fr.source_file
    FROM flight_raw fr

    -- 3. Enrich with dimension data
    UPDATE fcd
    SET 
        fcd.route_id = r.Route_ID,
        fcd.distance_km = r.[DISTANCE KM],
        fcd.block_hour = r.[BLOCK HOUR],
        fcd.seat = acs.seat
    FROM flight_clean_data_stg fcd
    LEFT JOIN Route r ON fcd.route = r.ROUTE
    LEFT JOIN actype_seat acs ON fcd.actype = acs.actype
END
```

**CÃ¡c bÆ°á»›c:**

1. **Clean data**: Uppercase, trim, format dates
2. **Insert vÃ o staging**: Copy tá»« `flight_raw` â†’ `flight_clean_data_stg`
3. **Enrich data**: Join vá»›i dimension tables
   - `Route`: Láº¥y route_id, distance, block_hour
   - `actype_seat`: Láº¥y sá»‘ gháº¿

---

#### 5.2. Stored Procedure 2: usp_CleanAndValidateFlightData

**Purpose:** Validate vÃ  move error data

```sql
CREATE PROCEDURE usp_CleanAndValidateFlightData
AS
BEGIN
    -- 1. Find records with missing dimensions
    INSERT INTO error_table (
        route, actype, flight_date, pax, error_reason, source_file
    )
    SELECT 
        route, actype, flight_date, pax,
        CASE 
            WHEN route_id IS NULL THEN 'Missing Route'
            WHEN seat IS NULL THEN 'Missing Actype'
            ELSE 'Unknown Error'
        END as error_reason,
        source_file
    FROM flight_clean_data_stg
    WHERE route_id IS NULL OR seat IS NULL

    -- 2. Log missing dimensions
    INSERT INTO Missing_Dimensions_Log (Type, Value, Count)
    SELECT 'ROUTE', route, COUNT(*)
    FROM flight_clean_data_stg
    WHERE route_id IS NULL
    GROUP BY route

    INSERT INTO Missing_Dimensions_Log (Type, Value, Count)
    SELECT 'ACTYPE', actype, COUNT(*)
    FROM flight_clean_data_stg
    WHERE seat IS NULL
    GROUP BY actype

    -- 3. Move valid records to final table
    INSERT INTO flight_data_chot (
        route, actype, flight_date, pax, route_id, 
        distance_km, block_hour, seat, source_file
    )
    SELECT 
        route, actype, flight_date, pax, route_id,
        distance_km, block_hour, seat, source_file
    FROM flight_clean_data_stg
    WHERE route_id IS NOT NULL AND seat IS NOT NULL

    -- 4. Clear staging table
    DELETE FROM flight_clean_data_stg
END
```

**CÃ¡c bÆ°á»›c:**

1. **Identify errors**: Records cÃ³ missing dimensions
2. **Move to error_table**: LÆ°u records lá»—i vá»›i error_reason
3. **Log missing dimensions**: Track actypes/routes thiáº¿u
4. **Move valid records**: Insert vÃ o final table `flight_data_chot`
5. **Clear staging**: XÃ³a staging table

---

#### 5.3. Láº¥y Processing Summary

##### 5.3.1. Method: `get_processing_summary()` - ToÃ n bá»™ Database

**MÃ´ táº£**: Láº¥y thá»‘ng kÃª **Táº¤T Cáº¢** dá»¯ liá»‡u trong database (dÃ¹ng cho dashboard tá»•ng quan)

**Sá»­ dá»¥ng**: Endpoint `/processing-summary`

```python
def get_processing_summary(self) -> Dict[str, Any]:
    """
    Láº¥y tÃ³m táº¯t quÃ¡ trÃ¬nh xá»­ lÃ½ dá»¯ liá»‡u theo schema thá»±c táº¿ (TOÃ€N Bá»˜ DATABASE)
    """
    try:
        # Get total records in each table
        raw_count_result = self.db.execute(
            text("SELECT COUNT(*) FROM flight_raw")
        ).fetchone()

        processed_count_result = self.db.execute(
            text("SELECT COUNT(*) FROM flight_data_chot")
        ).fetchone()

        error_count_result = self.db.execute(
            text("SELECT COUNT(*) FROM error_table")
        ).fetchone()

        missing_actype_result = self.db.execute(
            text("SELECT COUNT(*) FROM Missing_Dimensions_Log WHERE Type = 'ACTYPE'")
        ).fetchone()

        missing_route_result = self.db.execute(
            text("SELECT COUNT(*) FROM Missing_Dimensions_Log WHERE Type = 'ROUTE'")
        ).fetchone()

        imported_files_result = self.db.execute(
            text("SELECT COUNT(*) FROM import_log")
        ).fetchone()

        return {
            "raw_records": raw_count_result[0] if raw_count_result else 0,
            "processed_records": processed_count_result[0] if processed_count_result else 0,
            "error_records": error_count_result[0] if error_count_result else 0,
            "missing_actypes": missing_actype_result[0] if missing_actype_result else 0,
            "missing_routes": missing_route_result[0] if missing_route_result else 0,
            "imported_files": imported_files_result[0] if imported_files_result else 0,
        }
    except Exception as e:
        logging.error(f"Lá»—i láº¥y tÃ³m táº¯t quÃ¡ trÃ¬nh xá»­ lÃ½ dá»¯ liá»‡u: {e}")
        return {
            "raw_records": 0,
            "processed_records": 0,
            "error_records": 0,
            "missing_actypes": 0,
            "missing_routes": 0,
            "imported_files": 0,
        }
```

**Returns:**

- `raw_records`: Tá»•ng báº£n ghi trong `flight_raw` (toÃ n bá»™ DB)
- `processed_records`: Báº£n ghi Ä‘Ã£ xá»­ lÃ½ thÃ nh cÃ´ng trong `flight_data_chot` (toÃ n bá»™ DB)
- `error_records`: Báº£n ghi lá»—i trong `error_table` (toÃ n bá»™ DB)
- `missing_actypes`: Sá»‘ lÆ°á»£ng aircraft types thiáº¿u (toÃ n bá»™ DB)
- `missing_routes`: Sá»‘ lÆ°á»£ng routes thiáº¿u (toÃ n bá»™ DB)
- `imported_files`: Tá»•ng sá»‘ files Ä‘Ã£ import (toÃ n bá»™ DB)

##### 5.3.2. Method: `get_current_session_summary(source_files)` - Batch hiá»‡n táº¡i

**MÃ´ táº£**: Láº¥y thá»‘ng kÃª **CHá»ˆ CHO BATCH HIá»†N Táº I** (filtered theo danh sÃ¡ch files Ä‘Ã£ upload)

**Sá»­ dá»¥ng**: Endpoint `/upload-files` vÃ  `/complete-workflow`

```python
def get_current_session_summary(self, source_files: List[str]) -> Dict[str, Any]:
    """
    Láº¥y tÃ³m táº¯t quÃ¡ trÃ¬nh xá»­ lÃ½ CHá»ˆ CHO BATCH HIá»†N Táº I (filtered by source files)

    Args:
        source_files: Danh sÃ¡ch tÃªn files Ä‘Ã£ xá»­ lÃ½ trong session hiá»‡n táº¡i

    Returns:
        Dict[str, Any]: TÃ³m táº¯t quÃ¡ trÃ¬nh xá»­ lÃ½ cá»§a batch hiá»‡n táº¡i
    """
    try:
        if not source_files:
            return {
                "raw_records": 0,
                "processed_records": 0,
                "error_records": 0,
                "missing_actypes": 0,
                "missing_routes": 0,
                "imported_files": 0,
            }

        # Build IN clause for SQL query
        files_placeholder = ", ".join([f":file_{i}" for i in range(len(source_files))])
        files_params = {f"file_{i}": file for i, file in enumerate(source_files)}

        # Get records count from flight_raw for current batch
        raw_count_result = self.db.execute(
            text(f"SELECT COUNT(*) FROM flight_raw WHERE source IN ({files_placeholder})"),
            files_params
        ).fetchone()

        # Get records count from flight_data_chot for current batch
        processed_count_result = self.db.execute(
            text(f"SELECT COUNT(*) FROM flight_data_chot WHERE source IN ({files_placeholder})"),
            files_params
        ).fetchone()

        # Get records count from error_table for current batch
        error_count_result = self.db.execute(
            text(f"SELECT COUNT(*) FROM error_table WHERE source IN ({files_placeholder})"),
            files_params
        ).fetchone()

        # Get missing actypes from error_table for current batch
        missing_actype_result = self.db.execute(
            text(f"""
                SELECT COUNT(DISTINCT actype) 
                FROM error_table 
                WHERE source IN ({files_placeholder})
                AND Is_InvalidActypeSeat = 1
                AND actype IS NOT NULL
            """),
            files_params
        ).fetchone()

        # Get missing routes from error_table for current batch
        missing_route_result = self.db.execute(
            text(f"""
                SELECT COUNT(DISTINCT route) 
                FROM error_table 
                WHERE source IN ({files_placeholder})
                AND Is_InvalidRoute = 1
                AND route IS NOT NULL
            """),
            files_params
        ).fetchone()

        # Get imported files count for current batch
        imported_files_result = self.db.execute(
            text(f"SELECT COUNT(*) FROM import_log WHERE file_name IN ({files_placeholder})"),
            files_params
        ).fetchone()

        return {
            "raw_records": raw_count_result[0] if raw_count_result else 0,
            "processed_records": processed_count_result[0] if processed_count_result else 0,
            "error_records": error_count_result[0] if error_count_result else 0,
            "missing_actypes": missing_actype_result[0] if missing_actype_result else 0,
            "missing_routes": missing_route_result[0] if missing_route_result else 0,
            "imported_files": imported_files_result[0] if imported_files_result else 0,
        }

    except Exception as e:
        logging.error(f"Lá»—i láº¥y tÃ³m táº¯t batch hiá»‡n táº¡i: {e}")
        return {
            "raw_records": 0,
            "processed_records": 0,
            "error_records": 0,
            "missing_actypes": 0,
            "missing_routes": 0,
            "imported_files": 0,
        }
```

**Parameters:**

- `source_files`: List cÃ¡c tÃªn files Ä‘Ã£ xá»­ lÃ½ trong batch hiá»‡n táº¡i (VD: `["MN_Jan_2024.xlsx", "MB_Jan_2024.xlsx"]`)

**Returns:**

- `raw_records`: Báº£n ghi trong `flight_raw` tá»« batch hiá»‡n táº¡i
- `processed_records`: Báº£n ghi trong `flight_data_chot` tá»« batch hiá»‡n táº¡i
- `error_records`: Báº£n ghi lá»—i trong `error_table` tá»« batch hiá»‡n táº¡i
- `missing_actypes`: Sá»‘ lÆ°á»£ng DISTINCT actypes thiáº¿u tá»« batch hiá»‡n táº¡i
- `missing_routes`: Sá»‘ lÆ°á»£ng DISTINCT routes thiáº¿u tá»« batch hiá»‡n táº¡i
- `imported_files`: Sá»‘ files Ä‘Ã£ import trong batch hiá»‡n táº¡i

**CÃ¡ch sá»­ dá»¥ng trong endpoint:**

```python
# Extract file names from file_details
processed_file_names = [
    detail["file_name"] for detail in results["file_details"]
]

# Get processing summary for CURRENT BATCH only
results["processing_summary"] = processor.get_current_session_summary(
    processed_file_names
)
```

##### 5.3.3. So sÃ¡nh hai methods

| Aspect | `get_processing_summary()` | `get_current_session_summary()` |
|--------|---------------------------|--------------------------------|
| **Scope** | ToÃ n bá»™ database | Batch hiá»‡n táº¡i (filtered) |
| **Filter** | KhÃ´ng filter | Filter theo `source` column |
| **Use case** | Dashboard, tá»•ng quan | Upload workflow, batch result |
| **Performance** | Cháº­m hÆ¡n (full table scan) | Nhanh hÆ¡n (indexed filter) |
| **Endpoint** | `GET /processing-summary` | `POST /upload-files`, `/complete-workflow` |

**VÃ­ dá»¥ káº¿t quáº£:**

Upload 3 files vá»›i 450 records:

```json
// TrÆ°á»›c Ä‘Ã¢y (âŒ - dÃ¹ng get_processing_summary)
{
    "processed_files": 3,
    "total_rows": 450,
    "processing_summary": {
        "raw_records": 10000,      // âŒ Táº¥t cáº£ trong DB
        "processed_records": 9500,  // âŒ Táº¥t cáº£ trong DB
        "error_records": 500        // âŒ Táº¥t cáº£ trong DB
    }
}

// BÃ¢y giá» (âœ… - dÃ¹ng get_current_session_summary)
{
    "processed_files": 3,
    "total_rows": 450,
    "processing_summary": {
        "raw_records": 450,        // âœ… Chá»‰ 3 files vá»«a upload
        "processed_records": 420,  // âœ… Chá»‰ 3 files vá»«a upload
        "error_records": 30        // âœ… Chá»‰ 3 files vá»«a upload
    }
}
```

---

### BÆ°á»›c 6: Tráº£ vá» Káº¿t quáº£

```python
success_message = f"ÄÃ£ xá»­ lÃ½ thÃ nh cÃ´ng {results['processed_files']} file vá»›i tá»•ng {results['total_rows']} báº£n ghi"
if results["skipped_files"] > 0:
    success_message += f" (bá» qua {results['skipped_files']} file Ä‘Ã£ import)"

print(f"ğŸ‰ {success_message}")

return {"success": True, "message": success_message, **results}
```

**Response Structure:**

```json
{
    "success": true,
    "message": "ÄÃ£ xá»­ lÃ½ thÃ nh cÃ´ng 5 file vá»›i tá»•ng 1500 báº£n ghi (bá» qua 2 file Ä‘Ã£ import)",
    "processed_files": 5,
    "total_rows": 1500,
    "skipped_files": 2,
    "errors": [],
    "file_details": [
        {
            "file_name": "MN_Jan_2024.xlsx",
            "file_type": "MN",
            "rows": 300
        },
        {
            "file_name": "MB_Jan_2024.xlsx",
            "file_type": "MB",
            "rows": 400
        },
        ...
    ],
    "processing_summary": {
        "raw_records": 1500,
        "processed_records": 1450,
        "error_records": 50,
        "missing_actypes": 3,
        "missing_routes": 5,
        "imported_files": 7
    }
}
```

---

## ğŸ“Š DATABASE SCHEMA

### Tables Involved

#### 1. flight_raw

**Purpose:** LÆ°u dá»¯ liá»‡u raw tá»« Excel files

```sql
CREATE TABLE flight_raw (
    id INT IDENTITY(1,1) PRIMARY KEY,
    route VARCHAR(50),
    actype VARCHAR(20),
    flight_date DATE,
    pax INT,
    flight_number VARCHAR(20),
    departure_time TIME,
    arrival_time TIME,
    source_file VARCHAR(255),
    import_date DATETIME,
    created_at DATETIME DEFAULT GETDATE()
)
```

#### 2. import_log

**Purpose:** Track files Ä‘Ã£ import (prevent duplicates)

```sql
CREATE TABLE import_log (
    id INT IDENTITY(1,1) PRIMARY KEY,
    file_name VARCHAR(255) UNIQUE,
    file_type VARCHAR(10),  -- MN, MB, MT
    row_count INT,
    import_date DATETIME,
    status VARCHAR(20),  -- success, failed
    created_at DATETIME DEFAULT GETDATE()
)
```

#### 3. flight_clean_data_stg

**Purpose:** Staging table cho data cleaning

```sql
CREATE TABLE flight_clean_data_stg (
    id INT IDENTITY(1,1) PRIMARY KEY,
    route VARCHAR(50),
    actype VARCHAR(20),
    flight_date DATE,
    pax INT,
    flight_number VARCHAR(20),
    departure_time TIME,
    arrival_time TIME,
    route_id INT,
    distance_km DECIMAL(10,2),
    block_hour DECIMAL(5,2),
    seat INT,
    source_file VARCHAR(255)
)
```

#### 4. flight_data_chot

**Purpose:** Final table chá»©a dá»¯ liá»‡u Ä‘Ã£ validated

```sql
CREATE TABLE flight_data_chot (
    id INT IDENTITY(1,1) PRIMARY KEY,
    route VARCHAR(50),
    actype VARCHAR(20),
    flight_date DATE,
    pax INT,
    flight_number VARCHAR(20),
    route_id INT,
    distance_km DECIMAL(10,2),
    block_hour DECIMAL(5,2),
    seat INT,
    load_factor DECIMAL(5,2),  -- Calculated: pax/seat
    source_file VARCHAR(255),
    created_at DATETIME DEFAULT GETDATE()
)
```

#### 5. error_table

**Purpose:** LÆ°u records cÃ³ lá»—i

```sql
CREATE TABLE error_table (
    id INT IDENTITY(1,1) PRIMARY KEY,
    route VARCHAR(50),
    actype VARCHAR(20),
    flight_date DATE,
    pax INT,
    error_reason VARCHAR(255),
    source_file VARCHAR(255),
    created_at DATETIME DEFAULT GETDATE()
)
```

#### 6. Missing_Dimensions_Log

**Purpose:** Log dimensions thiáº¿u (actypes/routes)

```sql
CREATE TABLE Missing_Dimensions_Log (
    id INT IDENTITY(1,1) PRIMARY KEY,
    Type VARCHAR(20),  -- ACTYPE, ROUTE
    Value VARCHAR(100),
    Count INT,
    created_at DATETIME DEFAULT GETDATE()
)
```

---

## ğŸ”„ DATA FLOW DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Excel File â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  flight_raw     â”‚  â† Raw data import
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“  (SP: usp_CleanAndProcessFlightData)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ flight_clean_data_stg  â”‚  â† Staging + Enrichment
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“  (SP: usp_CleanAndValidateFlightData)
       â”‚
    â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚flight_data   â”‚  â”‚error_table  â”‚
â”‚   _chot      â”‚  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚Missing_Dimensions_Log   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ KEY FEATURES & OPTIMIZATION

### 1. Duplicate Prevention

**Implementation:**

- Check `import_log` table trÆ°á»›c khi process
- Skip files Ä‘Ã£ import
- Return info vá» skipped files

**Benefits:**

- TrÃ¡nh duplicate data
- Save processing time
- Audit trail Ä‘áº§y Ä‘á»§

---

### 2. File Type Detection

**Implementation:**

```python
def find_matching_key(self, filename: str) -> Optional[str]:
    patterns = {
        'MN': ['mn', 'miá»n nam', 'mien nam'],
        'MB': ['mb', 'miá»n báº¯c', 'mien bac'],
        'MT': ['mt', 'miá»n trung', 'mien trung']
    }
    
    filename_lower = filename.lower()
    for key, keywords in patterns.items():
        if any(keyword in filename_lower for keyword in keywords):
            return key
    return None
```

**Benefits:**

- Tá»± Ä‘á»™ng phÃ¢n loáº¡i file
- Ãp dá»¥ng logic xá»­ lÃ½ phÃ¹ há»£p
- Support multiple naming conventions

---

### 3. Transaction Management

**Strategy:**

1. **Transaction 1: Raw Import**
   - Save all files vÃ o `flight_raw`
   - Mark imported trong `import_log`
   - Commit

2. **Transaction 2: Data Cleaning**
   - Run stored procedures
   - Move data qua cÃ¡c tables
   - Commit

**Benefits:**

- TÃ¡ch biá»‡t concerns
- Náº¿u cleaning fail, raw data váº«n giá»¯
- CÃ³ thá»ƒ rerun cleaning

---

### 4. Error Handling

**Strategy:**

- Try-catch tá»«ng file
- KhÃ´ng dá»«ng batch náº¿u 1 file fail
- Track errors trong array
- Return táº¥t cáº£ errors vá» frontend

**Example:**

```python
for file in files:
    try:
        # Process file
        ...
    except Exception as e:
        results["errors"].append(f"Lá»—i file {filename}: {str(e)}")
        continue  # Continue with next file
```

**Benefits:**

- Robust processing
- Partial success possible
- Full error visibility

---

### 5. Temp Directory Usage

**Implementation:**

```python
with tempfile.TemporaryDirectory() as temp_dir:
    # Save and process files
    ...
# Auto cleanup here
```

**Benefits:**

- Automatic cleanup
- No disk space leak
- Secure (OS handles security)
- Cross-platform compatible

---

### 6. Processing Summary

**Real-time Statistics:**

- `raw_records`: Input data count
- `processed_records`: Successfully processed
- `error_records`: Failed validations
- `missing_actypes`: Dimensions thiáº¿u
- `missing_routes`: Routes thiáº¿u
- `imported_files`: Total files imported

**Benefits:**

- Transparency
- Data quality monitoring
- Identify issues quickly

---

## ğŸš¨ ERROR SCENARIOS & HANDLING

### Scenario 1: Invalid File Extension

**Error:** User upload `.csv` hoáº·c `.pdf`

**Handling:**

```python
if not file.filename.lower().endswith((".xlsx", ".xls")):
    results["errors"].append(
        f"File {file.filename} khÃ´ng pháº£i lÃ  Excel file"
    )
    continue
```

**Result:** Skip file, thÃ´ng bÃ¡o error, continue vá»›i files khÃ¡c

---

### Scenario 2: File Already Imported

**Error:** Upload file Ä‘Ã£ import trÆ°á»›c Ä‘Ã³

**Handling:**

```python
if processor.is_file_imported(filename_only):
    print(f"â­ï¸ File {filename_only} Ä‘Ã£ Ä‘Æ°á»£c import trÆ°á»›c Ä‘Ã³")
    results["skipped_files"] += 1
    continue
```

**Result:** Skip file, increment `skipped_files`, khÃ´ng bÃ¡o error

---

### Scenario 3: Unknown File Type

**Error:** Filename khÃ´ng match patterns (MN/MB/MT)

**Handling:**

```python
file_type = processor.find_matching_key(filename_only)
if not file_type:
    results["errors"].append(
        f"KhÃ´ng thá»ƒ xÃ¡c Ä‘á»‹nh loáº¡i file: {filename_only}"
    )
    continue
```

**Result:** Skip file, thÃ´ng bÃ¡o error

---

### Scenario 4: Empty Excel File

**Error:** Excel file khÃ´ng cÃ³ data hoáº·c empty DataFrame

**Handling:**

```python
df = processor.process_excel_file(file_path, filename_only)

if df.empty:
    results["errors"].append(
        f"KhÃ´ng cÃ³ dá»¯ liá»‡u tá»« file {filename_only}"
    )
    continue
```

**Result:** Skip file, thÃ´ng bÃ¡o error

---

### Scenario 5: Missing Dimensions

**Error:** Data cÃ³ actype hoáº·c route khÃ´ng tá»“n táº¡i trong dimension tables

**Handling:**

1. Stored procedure detect missing dimensions
2. Move records vÃ o `error_table`
3. Log vÃ o `Missing_Dimensions_Log`
4. Return summary vá»›i `missing_actypes` vÃ  `missing_routes`

**Result:**

- Error records Ä‘Æ°á»£c track
- User biáº¿t cáº§n bá»• sung dimensions nÃ o
- CÃ³ thá»ƒ export missing dimensions Ä‘á»ƒ Ä‘iá»n thÃ´ng tin

---

### Scenario 6: Database Error

**Error:** Connection lost, constraint violation, etc.

**Handling:**

```python
try:
    # Process all files
    ...
except Exception as e:
    db.rollback()
    error_msg = f"Lá»—i upload files: {str(e)}"
    logging.error(error_msg)
    raise HTTPException(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        detail=error_msg
    )
```

**Result:**

- Rollback transaction
- Log error
- Return HTTP 500 error
- Frontend hiá»ƒn thá»‹ error toast

---

## ğŸ“ BEST PRACTICES

### 1. Logging Strategy

```python
# Console logging for debugging
print(f"ğŸ“¤ Báº¯t Ä‘áº§u upload vÃ  xá»­ lÃ½ {len(files)} file Excel...")
print(f"ğŸ“ Processing file: {file.filename} -> {filename_only}")
print(f"âœ… ÄÃ£ lÆ°u {row_count} báº£n ghi tá»« file {filename_only}")

# Error logging
logging.error(f"Error processing Excel data: {e}")
```

**Benefits:**

- Easy debugging
- Production monitoring
- Audit trail

---

### 2. Validation Layers

**Layer 1: File Extension**

```python
if not file.filename.lower().endswith((".xlsx", ".xls")):
    # Reject
```

**Layer 2: Duplicate Check**

```python
if processor.is_file_imported(filename_only):
    # Skip
```

**Layer 3: File Type Detection**

```python
file_type = processor.find_matching_key(filename_only)
if not file_type:
    # Reject
```

**Layer 4: Data Validation**

```python
if df.empty:
    # Reject
```

**Layer 5: Business Rules (Stored Procedures)**

- Check dimensions exist
- Validate data integrity
- Move errors to separate table

---

### 3. Response Structure

```python
return {
    "success": True,
    "message": "...",
    "processed_files": 5,
    "total_rows": 1500,
    "skipped_files": 2,
    "errors": [...],
    "file_details": [...],
    "processing_summary": {...}
}
```

**Benefits:**

- Complete information
- Easy frontend parsing
- Consistent structure

---

### 4. Frontend Error Display

```typescript
// Show first 3 errors with delay
result.errors.slice(0, 3).forEach((error: string, index: number) => {
    setTimeout(() => {
        toast.error(`Lá»—i ${index + 1}`, {
            description: error,
        })
    }, (index + 1) * 1000)
})

// Show "more errors" message
if (result.errors.length > 3) {
    setTimeout(() => {
        toast.info("CÃ³ thÃªm lá»—i khÃ¡c", {
            description: `VÃ  ${result.errors.length - 3} lá»—i khÃ¡c...`,
        })
    }, 4000)
}
```

**Benefits:**

- Don't overwhelm user
- Sequential display (readable)
- Complete error info in console

---

## ğŸ” SECURITY CONSIDERATIONS

### 1. File Validation

- Check extension before processing
- Validate file size (prevent DOS)
- Scan for malicious content (if needed)

### 2. SQL Injection Prevention

- Use parameterized queries
- SQLAlchemy ORM (automatic escaping)
- Stored procedures (controlled execution)

### 3. Temp File Security

- Use OS-provided temp directory
- Automatic cleanup
- Unique names (no collision)

### 4. Database Security

- Use connection pooling
- Proper transaction isolation
- Rollback on errors

---

## ğŸ¯ PERFORMANCE OPTIMIZATION

### 1. Bulk Insert

```python
# Bad: Insert one by one with commit
for record in records:
    db.add(FlightRaw(**record))
    db.commit()  # âŒ Slow

# Good: Bulk insert with single commit
for record in records:
    db.add(FlightRaw(**record))
db.commit()  # âœ… Fast
```

### 2. Temp Directory

- Faster than persistent storage
- Often in memory (tmpfs on Linux)
- OS-optimized

### 3. Stored Procedures

- Compiled execution plan
- Reduce network round-trips
- Batch operations
- Database-side processing

### 4. Async File Reading

```python
content = await file.read()  # Non-blocking I/O
```

---

## ğŸ“š FUTURE ENHANCEMENTS

### 1. Parallel Processing

```python
# Use asyncio for parallel file processing
import asyncio

async def process_file_async(file, processor, db):
    # Process file logic
    ...

# Process multiple files in parallel
tasks = [process_file_async(file, processor, db) for file in files]
await asyncio.gather(*tasks)
```

### 2. Progress Tracking

```python
# WebSocket or SSE for real-time progress
async def upload_with_progress(files):
    for i, file in enumerate(files):
        # Process file
        ...
        # Send progress
        await websocket.send({
            "progress": (i + 1) / len(files) * 100,
            "current_file": file.filename
        })
```

### 3. Background Jobs

```python
# Use Celery or RQ for background processing
from celery import Celery

@app.task
def process_excel_background(file_paths):
    # Long-running process
    ...
    
# Immediate response to user
task = process_excel_background.delay(file_paths)
return {"task_id": task.id}
```

### 4. File Validation Service

```python
# Dedicated service for file validation
class FileValidator:
    def validate_schema(self, df, expected_columns):
        # Check columns match
        ...
    
    def validate_data_types(self, df, schema):
        # Check data types
        ...
    
    def validate_business_rules(self, df):
        # Check business constraints
        ...
```

---

## ğŸ CONCLUSION

Flow xá»­ lÃ½ batch file Excel nÃ y implement má»™t pipeline hoÃ n chá»‰nh:

1. âœ… **Upload**: Multi-file upload vá»›i validation
2. âœ… **Processing**: PhÃ¢n loáº¡i, clean, transform data
3. âœ… **Storage**: LÆ°u vÃ o database theo layers
4. âœ… **Validation**: Multiple validation layers
5. âœ… **Error Handling**: Robust error tracking
6. âœ… **Feedback**: Real-time progress vÃ  results

**Key Strengths:**

- Robust error handling
- Transaction safety
- Duplicate prevention
- Detailed tracking & logging
- User-friendly feedback
- Scalable architecture

**Technologies Used:**

- **Frontend**: React + TypeScript + Sonner (toast)
- **Backend**: FastAPI + SQLAlchemy + Pandas
- **Database**: SQL Server + Stored Procedures
- **File Handling**: Python tempfile module

---

## ğŸ“– REFERENCES

- [FastAPI File Upload](https://fastapi.tiangolo.com/tutorial/request-files/)
- [Pandas Excel Operations](https://pandas.pydata.org/docs/reference/api/pandas.read_excel.html)
- [SQLAlchemy ORM](https://docs.sqlalchemy.org/en/14/orm/)
- [Python tempfile Module](https://docs.python.org/3/library/tempfile.html)

---

**Document Version:** 1.0  
**Last Updated:** 2024-01-13  
**Author:** AI Assistant  
**Project:** Airline Data Processing System
